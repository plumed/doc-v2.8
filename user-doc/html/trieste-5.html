<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<title>PLUMED: Trieste tutorial: Running and analyzing multi-replica simulations.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script>
   var redpath = "";
   
   function showPath(eg,name) {
     var i; var y = document.getElementsByName(redpath);
     for (i=0; i < y.length; i++ ) { y[i].style.color="black"; }
     var x = document.getElementsByName(name); redpath=name;
     for (i = 0; i < x.length; i++) { x[i].style.color="red"; }
     var valid="value_details_".concat(eg);
     var valueField = document.getElementById(valid);
     var dataField = document.getElementById(name);
     valueField.innerHTML = dataField.innerHTML;
   }
   function swapInput(name) {
     var btn = document.getElementById(name + "_button");
     var mydiv = document.getElementById("input_" + name);
     if( btn.textContent=="expand shortcuts" ) {
         btn.textContent = "contract shortcuts";
         var dataField = document.getElementById(name + "long");
         mydiv.innerHTML = dataField.innerHTML;
     } else if( btn.textContent=="contract shortcuts" ) {
         btn.textContent = "expand shortcuts";
         var dataField = document.getElementById(name + "short");
         mydiv.innerHTML = dataField.innerHTML;
     }
   }
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table align="center" frame="void" width="98%" cellpadding="2%">
<tbody>
<tr style="height: 30px;">
<td valign="center"> &nbsp; <img src="pigeon.png" width="120"/></td>
<td style="padding-left: 0.2em;" width="74%"> <a href="http://www.plumed.org"> <img src="logo.png" width="400" /> </td>
<td style="padding-left: 0.2em;" align="right"> <a href="../../developer-doc/html/index.html"> <img src="user-logo.png" width="180" /> </a> </td>
</tr>
</tbody>
</table>
<!--
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">PLUMED
   &#160;<span id="projectnumber">2.8.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
-->
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('trieste-5.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Trieste tutorial: Running and analyzing multi-replica simulations. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="trieste-5-aims"></a>
Aims</h1>
<p>The aim of this tutorial is to show how to use PLUMED to run simulations with multiple replicas and how to analyze them. In particular, we will focus on cases where the replicas feel different biasing potentials.</p>
<h1><a class="anchor" id="trieste-5-lo"></a>
Objectives</h1>
<p>Once this tutorial is completed students will be able to:</p>
<ul>
<li>Write plumed input files suitable for multi-replica simulations.</li>
<li>Run replica exchange simulations with gromacs and plumed using different bias potentials in each replica.</li>
<li>Analyze replica exchange simulations using WHAM so as to obtain the weight of each snapshot.</li>
</ul>
<h1><a class="anchor" id="trieste-5-resources"></a>
Resources</h1>
<p>The <span style="background-color:yellow"><a href="tutorial-resources/trieste-5.tar.gz" style="font-weight:bold" style="color:green" download="trieste-5.tar.gz">TARBALL</a> </span> for this project contains the following files:</p><ul>
<li><code>topol0.tpr</code>, <code>topol1.tpr</code>, <code>topol2.tpr</code>, and <code>topol3.tpr</code>, gromacs input files for analine dipeptide. Notice that two of them (0 and 2) are initialized in one free-energy well and two of them (1 and 3) in the other free-energy well.</li>
<li>A directory SCRIPT that contains a <code>wham.py</code> script to perform WHAM. Notice that this required python 3 (does not work with python 2).</li>
<li>A directory SETUP with the gromacs input file that can be used to generate new tpr files.</li>
</ul>
<p>This tutorial has been tested on a pre-release version of version 2.4. In particular, it takes advantage of a special syntax for setting up multi-replica simulations that is only available since version 2.4. Exercise could be done also with version 2.3 but using a different syntax with respect to the one suggested.</p>
<p>Also notice that in the <code>.solutions</code> directory of the tarball you will find correct input files. Please only look at these files after you have tried to solve the problems yourself.</p>
<h1><a class="anchor" id="trieste-5-introduction"></a>
Introduction</h1>
<p>So far we always used PLUMED to run one simulation at a time. However, PLUMED can also be used in multi-replica algorithms. When coupled with GROMACS (at least) it is also possible to run replica exchange simulations, where coordinates are swapped from time to time. In this case, PLUMED is going to take into account the different bias potentials applied to different replicas so as to compute correctly the acceptance.</p>
<p>Similarly to what we did before, we will first use the <a class="el" href="driver.html">driver</a> to understand how to prepare multi-replica input files. However, the very same holds when you run multi-replica MD simulations with MD codes that support them. For instance, in GROMACS that would be using the <code>-multi</code> option of <code>mdrun</code>.</p>
<p>Notice that this tutorial was tested using a pre-release version of PLUMED 2.4. In particular, we will use a special syntax for multi-replica input that is only available starting with PLUMED 2.4.</p>
<h1><a class="anchor" id="trieste-5-replicas"></a>
Multi replica input files</h1>
<p>Imagine that you are in a directory with these files </p><pre class="fragment">traj.0.xtc
traj.1.xtc
traj.2.xtc
plumed.dat
</pre><p> That is: three trajectories and a PLUMED input files. Let's say that the content of <code>plumed.dat</code> is </p>
<div style="width: 90%; float:left" id="value_details_eg1"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.8-passing-green.svg" alt="tested on v2.8" /></div><pre style="width: 97%;" class="fragment">
<b name="eg1d" onclick='showPath("eg1","eg1d")'>d: </b><a href="https://www.plumed.org/doc-v2.8/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=1,2 <span style="display:none;" id="eg1d">The DISTANCE action with label <b>d</b> calculates a single scalar value</span>
<a href="https://www.plumed.org/doc-v2.8/user-doc/html/_p_r_i_n_t.html" style="color:green">PRINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg1d">d</b> <div class="tooltip">FILE<div class="right">the name of the file on which to output these quantities <i></i></div></div>=COLVAR <span style="display:none;" id="eg1">The PRINT action with label <b></b></span>
</pre>
<p>You can use the following command to process the three trajectories simultaneously: </p><pre class="fragment">mpirun -np 3 plumed driver --multi 3 --plumed plumed.dat --mf_xtc traj.xtc
</pre><p> This command will produce three COLVAR files, namely <code>COLVAR.0</code>, <code>COLVAR.1</code>, and <code>COLVAR.2</code>.</p>
<p>How does this work?</p>
<p>You are here running three replicas of the <code>plumed</code> executable. When PLUMED opens a file for <b>writing</b> it adds a a suffix corresponding to the replica number. This is done for all the possible files written by PLUMED and allows you to distinguish the output of different replicas redirecting it to different files.</p>
<dl class="section attention"><dt>Attention</dt><dd>This is true also for input files that are opened for <b>reading</b>. However, when PLUMED does not find the input file with the replica suffix, it looks for the file without the suffix. That's why here it is sufficient to provide a single <code>plumed.dat</code> file. If by mistake you include an additional <code>plumed.0.dat</code> file in the same directory, PLUMED will use that file for replica 0 (and <code>plumed.dat</code> for replicas 1 and 2). To be precise, this is true for all the files read by PLUMED, with the exception of PDB files where the suffix is never added.</dd></dl>
<p>The last comment implies that if you need to process your trajectories with <em>different</em> input files you might do it creating files named <code>plumed.0.dat</code>, <code>plumed.1.dat</code>, and <code>plumed.2.dat</code>. This is correct, and this was the only way to do multi-replica simulations with different input files up to PLUMED 2.3. However, in the following we will see how to obtain the same effect with a new special command that has been introduced in PLUMED 2.4.</p>
<h1><a class="anchor" id="trieste-5-replica-special-syntax"></a>
Using special syntax for multiple replicas</h1>
<p>In many cases, we need to run multiple replicas with almost identical PLUMED files. These files might be prepared with cut-and-paste, which is very error prone, or could be set up with some smart bash or python script. Additionally, one can take advantage of the <a class="el" href="_i_n_c_l_u_d_e.html">INCLUDE</a> keyword so as to have a shared input file with common definitions and specific input files with replica-dependent keywords. However, as of PLUMED 2.4, we introduced a simpler manner to manipulate multiple replica inputs with tiny differences. Look at the following example:</p>

<div style="width: 90%; float:left" id="value_details_eg2"> Click on the labels of the actions for more information on what each action computes </div>
<div style="width: 10%; float:left"><img src="https://img.shields.io/badge/v2.8-passing-green.svg" alt="tested on v2.8" /></div><pre style="width: 97%;" class="fragment">
<span style="color:blue">#SETTINGS NREPLICAS=3</span>
<span style="color:blue"># Compute a distance</span>
<b name="eg2d" onclick='showPath("eg2","eg2d")'>d: </b><a href="https://www.plumed.org/doc-v2.8/user-doc/html/_d_i_s_t_a_n_c_e.html" style="color:green">DISTANCE</a> <div class="tooltip">ATOMS<div class="right">the pair of atom that we are calculating the distance between. <i></i></div></div>=1,2 <span style="display:none;" id="eg2d">The DISTANCE action with label <b>d</b> calculates a single scalar value</span>
<span style="color:blue"># Apply a restraint.</span>
<a href="https://www.plumed.org/doc-v2.8/user-doc/html/_r_e_s_t_r_a_i_n_t.html" style="color:green">RESTRAINT</a> <div class="tooltip">ARG<div class="right">the input for this action is the scalar output from one or more other actions. <i></i></div></div>=<b name="eg2d">d</b> <div class="tooltip">AT<div class="right"><b>compulsory keyword </b>
the position of the restraint <i></i></div></div>=@replicas:1.0,1.1,1.2 <div class="tooltip">KAPPA<div class="right"><b>compulsory keyword ( default=0.0 )</b>
specifies that the restraint is harmonic and what the values of the force constants
on each of the variables are <i></i></div></div>=1.0 <span style="display:none;" id="eg2">The RESTRAINT action with label <b></b></span>
<span style="color:blue"># On replica 0, this means:</span>
<span style="color:blue"># RESTRAINT ARG=d AT=1.0 KAPPA=1.0</span>
<span style="color:blue"># On replica 1, this means:</span>
<span style="color:blue"># RESTRAINT ARG=d AT=1.1 KAPPA=1.0</span>
<span style="color:blue"># On replica 2, this means:</span>
<span style="color:blue"># RESTRAINT ARG=d AT=1.2 KAPPA=1.0</span>
</pre>
<p>If you prepare a single <code>plumed.dat</code> file like this one and feeds it to PLUMED while using 3 replicas, the 3 replicas will see the very same input except for the <code>AT</code> keyword, that sets the position of the restraint. Replica 0 will see a restraint centered at 1.0, replica 1 centered at 1.1, and replica 2 centered at 1.2.</p>
<p>The <code>
